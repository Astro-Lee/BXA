language: python

os:
  - linux

python:
  - "2.7"
  - "3.8"

env:
  - TOOL=xspec
  - TOOL=sherpa

services:
  - docker

before_install:
  # Load cached docker images
  - >
    if [[ -d $HOME/docker ]]; then 
      for i in $HOME/docker/*.tar.gz; do 
        echo "unpacking $i docker image";
        < $i gunzip | docker load || true
      done
    fi

install:
  - pip install requests corner astropy h5py cython 
  - pip install ultranest
  - python setup.py install

script:
  # testing scripts
  - pushd docker/testsrc
  - 'echo "backend: Agg" > matplotlibrc'
  - ls 
  - rm *.nh
  - python ../../fixkeywords.py combined_src.pi combined_bkg.pi combined_src.rmf combined_src.arf
  - python ../../gal.py combined_src.pi
  - git checkout .
  # testing sherpa, but not twice for each python version
  - if [[ "$TOOL" == "sherpa" ]] && [[ "$TRAVIS_PYTHON_VERSION" == 2.7 ]]; then
      docker run $XDOCKERARGS -v $PWD:/opt/example/ -e FILENAME=combined_src.pi -e ELO=0.5 -e EHI=8 -e NLIVEPOINTS=100 -t johannesbuchner/bxa_absorbed </dev/null;
    fi
  - popd
  # testing xspec
  - if [[ "$TOOL" == "xspec" ]] && [[ "$TRAVIS_PYTHON_VERSION" == 2.7 ]]; then
      docker run --rm -v $PWD/examples/xspec:/opt/script/ -v $PWD:/opt/BXA giacomov/xspec-docker bash /opt/script/test-docker.sh </dev/null;
    fi
